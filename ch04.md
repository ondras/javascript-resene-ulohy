# Kapitola 4: Vše o událostech

## Zadání

Vzpomínkový web o Karlu Gottovi je velmi populární a rádi bychom s jeho uživateli a fanoušky vstoupili do bližšího kontaktu. Na konci stránky chceme formulář, kde bude moci uživatel vložit svůj názor a zanechat na sebe telefon či e-mail, abychom se na něj mohli případně obrátit. Formulář by měl jít odeslat pouze při správně vyplněném e-mailu či telefonním čísle.

## Řešení

```html
<form>
	<h3>Zanechejte nám vzkaz!</h3>
	<textarea name="text"></textarea>
	<label>
		Váš e-mail: <input type="email" name="email" />
	</label>
	<label>
		nebo telefon: <input type="tel" name="tel" />
	</label>
	<label>
		<input type="submit" value="Poslat vzkaz" />
	</label>
</form>
```

```js
let form = document.querySelector("form");
let email = form.querySelector("[name=email]");
let tel = form.querySelector("[name=tel]");

const TEL_RE = /^\+?\d{5,12}$/;

function isEmpty(input) {
	return input.value.trim() == "";
}

function checkForm(e) {
	if (isEmpty(email) && isEmpty(tel)) {
		alert("Vyplňte e-mail nebo telefon");
		e.preventDefault();
		return;
	}

	if (!isEmpty(tel)) {
		let t = tel.value;
		if (!t.match(TEL_RE)) {
			tel.classList.add("error");
			e.preventDefault();
		}
	}
}

form.addEventListener("submit", checkForm);
```

První část řešení je opět fragment HTML dokumentu. Nebudeme se mu věnovat příliš zevrubně, protože znalost HTML u čtenáře předpokládáme a tato kniha se soustředí více na JavaScript. U formuláře pro jednoduchost nejsou specifikovány atributy `method` ani `action`, které by ve skutečnosti rozhodně chybět neměly (jejich hodnoty ovšem pro náš kód nejsou podstatné). Popisky pro jednotlivé značky `<input>` vkládáme do značek `<label>` (a tyto dva spolu propojíme zanořením). Tím jednak napomáháme přístupnosti dokumentu a jednak je pak kliknutím na popisek možno aktivovat jemu odpovídající formulářové pole.

Pro zadávání e-mailu je vhodný `<input type="email">`, který sám od sebe kontroluje korektní formát zadané adresy a zároveň na softwarové klávesnici (v mobilních zařízeních) rovnou nabízí nezbytný znak zavináče. Stejně tak pro zadávání telefonu se nabízí `<input type="tel">`, pro který se zobrazí klávesnice číselná. Zde ovšem žádná kontrola vstupu sama od sebe neproběhne, a tak ji budeme muset naimplementovat sami v JavaScriptu.

V tradiční úloze kontroly formulářových polí se pohybujeme na nejisté hranici mezi JavaScriptem a HTML. Atributy `required` a `pattern` nám dovolují definovat kontrolní podmínky přímo v HTML stránce bez nutnosti JavaScriptu, ale jejich schopnosti nejsou velké. HTML kontrola je prováděna jen pro konkrétní izolované pole (bez vazby na ostatní položky), jsme velmi omezeni možností zobrazení textu chyby a kontrolu můžeme specifikovat jen pomocí tzv. *regulárních výrazů*. Proto ji použijeme pro e-mailové pole a to telefonní zkontrolujeme pomocí JavaScriptu.

V něm nejprve na prvních třech řádcích používáme rozhraní DOM pro získání důležitých prvků -- formuláře a obou inputů. Metodě `querySelector` tentokrát předáváme složitější (atributové) selektory. Rozhodně to není jediný způsob; další možností by byl například výběr pomocí atributu `type`. Následuje naše první konstanta `TEL_RE`, ve které specifikujeme regulární výraz pro telefonní číslo. Jedná se o jakýsi *vzor* nebo *šablonu*, která speciálními znaky popisuje, jak má vypadat platná hodnota. Za zmínku stojí, že regulární výrazy mají v JavaScriptu vlastní datový typ a proměnné tohoto typu vznikají zápisem mezi dvě dopředná lomítka. Ve složitějších případech je můžeme vyrábět také funkcí `RegExp()`.

Jazyk a celý koncept regulárních výrazů převyšuje rozsah této knihy, takže si jen v rychlosti vyložíme části našeho jednoduchého výrazu:

  - Znaky `^` a `$` na začátku resp. konci výrazu říkají, že tomuto vzoru musí vyhovovat celý text kontrolovaného pole, tedy nikoliv jen nějaká podmnožina (kolem které by pak mohly být nesouvisející neplatné znaky).
  - Zápis `\+?` určuje, že text smí začínat jedním znakem plus (v telefonním čísle tzv. mezinárodní volací kód).
  - Zápis `\d{5,12}` určuje, že zbytek textu má obsahovat posloupnost pěti až dvanácti číslic.

Nejedná se o univerzálně spolehlivou kontrolu telefonního čísla, ale ilustraci toho, jak bychom mohli zhruba postupovat. Tuto konstantu použijeme hned za chvíli, jakmile si nachystáme kontrolní funkci.

V kódu se nám hodí funkce dvě: jedna pro ověření prázdnosti formulářového pole (`isEmpty`) a jedna pro celou kontrolu formuláře (`checkForm`). Hlavní kontrolní funkci pak předáme jako parametr do `addEventListener`, neboť kontrolu chceme provést až v důsledku nějaké události. V této úloze se jako událost nabízí `"submit"`, tedy okamžik, kdy se uživatel chystá formulář odeslat. Tato událost je vázána na HTML formulář a tak funkci `addEventListener` voláme jako metodu proměnné `form`, do které jsme formulář přiřadili výše.

Zbývá nastudovat tělo funkce `checkForm`. Obsahuje dvě kontroly, které odpovídají zadání úlohy. První kontrola prostě ověří, že bylo vyplněno alespoň jedno pole. Využíváme zde pomocné funkce `isEmpty`, která z předaného inputu vybere vyplněný text, odstraní z něj případné přebytečné mezery na začátku a konci (metoda `trim()`) a ověří, zda něco zbylo. Zvídavý čtenář si může povšimnout, že v porování se zadáním používáme obrácenou logiku: namísto testu *je nějaké pole vyplněné?* se ptáme *jsou obě pole prázdná?*. Vlastně tedy ověřujeme, zdali je formulář vyplněn špatně. To nám dovoluje použít programátorský koncept nazvaný anglicky *Return Early*: chceme přestat vykonávat funkci jakmile ověříme, že to nemá smysl. Při nesprávném vyplnění zakončíme kód voláním `e.preventDefault()`, k jehož vysvětlení se dostaneme za malý okamžik.

Druhý test využívá regulárního výrazu z konstanty `TEL_RE` a pokud mu zadané telefonní číslo neodpovídá, nastává opět chybový stav. Tentokrát neukážeme uživateli nehezký `alert`, ale pokusíme se problém naznačit vizuálně -- například vyplněním políčka červenou barvou. Z JavaScriptu bychom sice pomocí DOM mohli přímo ovlivňovat vzhledové atributy daného prvku, ale takový postup je nepraktický, protože pro definici vzhledu upřednostňujeme jazyk CSS a těžko se nám pak bude hluboko uvnitř souborů JS hledat, kde a jak se kterému poli nastavuje jaká barva. Proto volíme přístup, kdy JavaScriptem měníme hodnotu atributu `class`, který v HTML slouží právě k tomuto účelu. Označujeme pomocí něj prvky, které se svými vlastnostmi nějak odlišují od ostatních a chceme na ně aplikovat specifická stylová pravidla. Fanoušci lososové barvy pak mohou doplnit například následující CSS:

```css
.error { background-color: salmon }
```

Z JavaScriptu ovšem nechceme nastavit atribut `class` na novou hodnotu `error`, neboť tento atribut může mít hodnot více (oddělených mezerami) a náš kód dopředu nemusí vědět, zdali a proč už tam nějaké hodnoty jsou. Je proto praktičtější postupovat *defenzivněji* a k existující hodnotě `class` jen něco přidat. K takovému účelu nejlépe slouží objekt `classList`, jehož metody dovolují k atributu `class` přidávat další hodnoty či odebírat existující.

Poslední otázkou k vyřešení je metoda `e.preventDefault()`, volaná v obou dílčích kontrolách. Jedná se o tzv. *metodu objektu události*, tedy logiku, která nám je k dispozici jen ve speciálních chvilkách, konkrétně v průběhu zpracování nějaké události. Vzpomeňme si, že náš současný kód (funkce `checkForm`) byl naplánován k vykonání teprve tehdy, když se uživatel pokusí odeslat formulář. Jakmile tato situace nastane, je v prohlížeči vytvořen *objekt události*, který popisuje skutečnosti pro tuto událost relevantní. Při vykonávání všech *posluchačů* dané události je pak objekt události každému posluchači předán jako parametr.

V objektu události nalezneme řadu užitečných informací a také několik metod. Ta nejdůležitější je `preventDefault`, nemá žádné parametry a pokud ji kterýkoliv posluchač vykoná, **žádá tím prohlížeč, aby na tuto událost po vykonání posluchačů dále nereagoval**. To je smysluplné jen u takových událostí, které představují nějakou aktivitu pro prohlížeč samotný: může jít o událost kliknutí na odkaz (způsobí navigaci), stisk klávesy ve formulářovém poli (způsobí vložení znaku) nebo kliknutí na odesílací tlačítko (způsobí odeslání formuláře). Když v našem kódu kontrola selže, voláním `e.preventDefault()` zařídíme, aby nedošlo k odeslání formuláře s neplatnými daty.

## Co jsme se naučili

Po vyřešení třetí úlohy by měl čtenář chápat a ovládat:

  - zamezení zpracování události metodou `preventDefault`
  - použití regulárního výrazu pro kontrolu textu
  - použití rozhraní `classList` pro snadnou úpravu HTML atributu `class`

## Zelenáči: další druhy událostí

## Koumáci: životní cyklus události

## Profíci:
